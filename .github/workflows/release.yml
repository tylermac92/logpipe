name: Release

on:
    push:
        tags:
            - 'v*.*.*'

permissions:
    contents: write

jobs:
    release:
        name: Release
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version-file: "go.mod"
                cache: true

            - name: Build release binaries
              env:
                CGO_ENABLED: 0
              run: |
                VERSION="${{ github.ref_name }}"
                LDFLAGS="-s -w -X main.version=${VERSION}"

                declare -a TARGETS=(
                    "linux/amd64"
                    "linux/arm64"
                    "darwin/amd64"
                    "darwin/arm64"
                    "windows/amd64"
                )

                mkdir -p dist

                for TARGET in "${TARGETS[@]}"; do
                    GOOS="${TARGET%/*}"
                    GOARCH="${TARGET#*/}"
                    OUTPUT="logpipe-${VERSION}-${GOOS}-${GOARCH}"
                    if [ "${GOOS}" = "windows" ]; then OUTPUT="${OUTPUT}.exe"; fi

                    echo "Building ${OUTPUT}..."
                    GOOS="${GOOS}" GOARCH="${GOARCH}" go build -ldflags="${LDFLAGS}" -o "${OUTPUT}" ./cmd/logpipe
                done

            - name: Generate checksums
              working-directory: dist
              run: sha256sum * > checksums.txt && cat checksums.txt

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                files: |
                    dist/*
                generate_release_notes: true
                fail_on_unmatched_files: false
                    
