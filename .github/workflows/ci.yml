name: CI

on:
    push:
        branches: ["main", "develop"]
    pull_request:
        branches: ["main"]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version-file: "go.mod"
                cache: true

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v6
              with:
                version: latest
                args: --timeout=5m

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version-file: "go.mod"
                cache: true

            - name: Run tests
              run: go test -v -race -coverprofile=coverage.out ./...

            - name: Show coverage summary
              run: go tool cover -func=coverage.out

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                files: coverage.out
                fail_ci_if_error: false

    build:
        name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
        runs-on: ubuntu-latest
        needs: [lint, test]

        strategy:
            matrix:
                include:
                    - goos: linux
                      goarch: amd64
                    - goos: linux
                      goarch: arm64
                    - goos: darwin
                      goarch: amd64
                    - goos: darwin
                      goarch: arm64
                    - goos: windows
                      goarch: amd64

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                go-version-file: "go.mod"
                cache: true

            - name: Build binary
              env:
                GOOS: ${{ matrix.goos }}
                GOARCH: ${{ matrix.goarch }}
                CGO_ENABLED: 0
              run: |
                OUTPUT="logpipe-${{ matrix.goos }}-${{ matrix.goarch }}"
                if [ "${{ matrix.goos }}" = "windows" ]; then OUTPUT="${OUTPUT}.exe"; fi
                go build -ldflags="-s -w" -o "dist/${OUTPUT}" ./cmd/logpipe

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                name: logpipe-${{ matrix.goos }}-${{ matrix.goarch }}
                path: dist/
                retention-days: 7